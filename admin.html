<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IPTV Admin Dashboard</title>
<!-- FontAwesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

<!-- Header -->
<header class="bg-white shadow-md px-6 py-4 sticky top-0 z-10 flex justify-between items-center">
  <h1 class="text-xl font-bold text-gray-800">Channel Manager</h1>
  <!-- Contact Icon -->
  <a href="mailto:tnm3us@gmail.com" class="text-gray-600 hover:text-gray-900 text-xl">
    <i class="fas fa-envelope"></i>
  </a>
</header>

<!-- Search & Filter -->
<section class="p-4 flex flex-col md:flex-row gap-4 items-center">
  <input type="text" placeholder="Search channels..." id="searchInput" class="w-full md:w-1/2 p-3 rounded border border-gray-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
  <select id="filterCategory" class="w-full md:w-1/4 p-3 rounded border border-gray-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
    <option value="All">All Categories</option>
    <option value="News">News</option>
    <option value="Movies">Movies</option>
    <option value="Music">Music</option>
    <option value="Sports">Sports</option>
    <option value="Kids">Kids</option>
    <option value="Entertainment">Entertainment</option>
    <option value="Lifestyle">Lifestyle</option>
    <option value="Devotional">Devotional</option>
    <option value="Education">Education</option>
    <option value="Local Channels">Local Channels</option>
  </select>
</section>

<!-- Channel List -->
<main class="p-4 flex flex-col gap-4" id="channelList">
  <!-- Channels will be appended here dynamically -->
</main>

<!-- Floating Add Button -->
<button id="fabAddChannel" class="fixed bottom-6 right-6 bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-lg flex items-center justify-center text-xl">
  <i class="fas fa-plus"></i>
</button>

<!-- Modal -->
<div id="channelModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-20">
  <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-sm p-6 relative">
    <h2 class="text-lg font-bold mb-4">Add/Edit Channel</h2>
    <form id="channelForm" class="flex flex-col gap-3">
      <input type="hidden" id="channelId">

      <input type="text" placeholder="Channel Name" id="name" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" required>

      <select id="category" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
        <option value="">Select Category</option>
        <option value="News">News</option>
        <option value="Movies">Movies</option>
        <option value="Music">Music</option>
        <option value="Sports">Sports</option>
        <option value="Kids">Kids</option>
        <option value="Entertainment">Entertainment</option>
        <option value="Lifestyle">Lifestyle</option>
        <option value="Devotional">Devotional</option>
        <option value="Education">Education</option>
        <option value="Local Channels">Local Channels</option>
      </select>

      <select id="channelType" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
        <option value="">Select Type</option>
        <option value="News">News</option>
        <option value="Movies">Movies</option>
        <option value="Music">Music</option>
        <option value="Sports">Sports</option>
        <option value="Kids">Kids</option>
        <option value="Entertainment">Entertainment</option>
        <option value="Lifestyle">Lifestyle</option>
        <option value="Devotional">Devotional</option>
        <option value="Education">Education</option>
        <option value="Local Channels">Local Channels</option>
      </select>

      <select id="language" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
        <option value="">Select Language</option>
        <option value="English">English</option>
        <option value="Hindi">Hindi</option>
        <option value="Tamil">Tamil</option>
        <option value="Telugu">Telugu</option>
        <option value="Kannada">Kannada</option>
        <option value="Malayalam">Malayalam</option>
      </select>

      <input type="text" placeholder="Country" id="country" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
      <input type="text" placeholder="Stream URL" id="stream" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" required>

      <!-- Icon Upload -->
      <div>
        <label class="block mb-1 font-semibold">Upload Icon</label>
        <input type="file" id="uploadIcon" accept="image/*" class="mb-1">
        <input type="hidden" id="icon">
        <p id="uploadStatus" class="text-sm text-gray-500"></p>
      </div>

      <input type="text" placeholder="Tags (comma separated)" id="tags" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500">
      <textarea placeholder="Description" id="description" rows="3" class="p-3 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>

      <div class="flex justify-end gap-2 mt-2">
        <button type="button" id="closeModal" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-700 text-white">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Footer -->
<footer class="bg-white p-4 text-center border-t border-gray-200 mt-auto text-gray-600 text-sm">
  IPTV Admin Panel V1.0 | Built & Maintained By Tnm3u
</footer>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getDatabase, ref, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

// NEW Firebase config (iptv-demo)
const firebaseConfig = {
  apiKey: "AIzaSyB5UoPPtjRcz3rJoJz13iTsdTF_InIMn2Y",
  authDomain: "iptv-demo.firebaseapp.com",
  projectId: "iptv-demo",
  storageBucket: "iptv-demo.firebasestorage.app",
  messagingSenderId: "899732153233",
  appId: "1:899732153233:web:b238e4c0254ce408c3b030"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// Elements
const channelList = document.getElementById('channelList');
const fabBtn = document.getElementById('fabAddChannel');
const modal = document.getElementById('channelModal');
const closeModalBtn = document.getElementById('closeModal');
const channelForm = document.getElementById('channelForm');
const searchInput = document.getElementById('searchInput');
const filterCategory = document.getElementById('filterCategory');
const uploadIconInput = document.getElementById('uploadIcon');
const iconHidden = document.getElementById('icon');
const uploadStatus = document.getElementById('uploadStatus');

let channelsData = {};

// Open/Close Modal
fabBtn.addEventListener('click', () => modal.classList.remove('hidden'));
closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
window.addEventListener('click', (e) => { if(e.target === modal) modal.classList.add('hidden'); });

// Upload Icon to IMGBB
uploadIconInput.addEventListener("change", async () => {
  const file = uploadIconInput.files[0];
  if(!file) return;
  uploadStatus.textContent = "Uploading...";
  const formData = new FormData();
  formData.append("image", file);
  try {
    const response = await fetch(`https://api.imgbb.com/1/upload?key=4a342055cd88165647c66ee5f4350b68`, {
      method: "POST",
      body: formData
    });
    const data = await response.json();
    if(data.success){
      iconHidden.value = data.data.url;
      showToast("Icon uploaded successfully!");
      uploadStatus.textContent = "";
    } else {
      showToast("Upload failed!", "error");
      uploadStatus.textContent = "";
    }
  } catch(err){
    showToast("Upload error!", "error");
    uploadStatus.textContent = "";
    console.error(err);
  }
});

// Toast
function showToast(msg, type="success"){
  const existing = document.querySelector(".toast");
  if(existing) existing.remove();
  const toast = document.createElement("div");
  toast.className = `toast fixed bottom-5 right-5 px-5 py-3 rounded-lg shadow-lg text-white font-semibold z-50 transition-transform transform ${type==="success"?"bg-green-600":type==="error"?"bg-red-600":"bg-gray-600"}`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  toast.style.opacity = "0";
  toast.style.transform = "translateY(50px)";
  setTimeout(()=>{
    toast.style.transition="opacity 0.3s, transform 0.3s";
    toast.style.opacity="1";
    toast.style.transform="translateY(0)";
  },50);
  setTimeout(()=>{
    toast.style.opacity="0";
    toast.style.transform="translateY(50px)";
    setTimeout(()=>toast.remove(),300);
  },3000);
}

// Auto-generate description
const nameInput = document.getElementById("name");
const channelTypeSelect = document.getElementById("channelType");
const descriptionBox = document.getElementById("description");

const descriptionTemplates = {
  News: name => `Stay updated with the latest news. Watch ${name} live on tnm3u.live.`,
  Movies: name => `Enjoy blockbuster hits on ${name}. Watch live on tnm3u.live.`,
  Music: name => `Feel the rhythm with ${name} live on tnm3u.live.`,
  Sports: name => `Follow your favorite sports on ${name}. Live on tnm3u.live.`,
  Kids: name => `Fun and learning for kids on ${name}.`,
  Entertainment: name => `Catch entertainment shows and movies on ${name}.`,
  Lifestyle: name => `Explore lifestyle content on ${name}.`,
  Devotional: name => `Spiritual programs and prayers on ${name}.`,
  Education: name => `Knowledge-packed programs on ${name}.`,
  "Local Channels": name => `Local news and events on ${name}.`
};

function autoGenerateDescription(){
  const name = nameInput.value.trim() || "this channel";
  const type = channelTypeSelect.value;
  if(descriptionTemplates[type]){
    descriptionBox.value = descriptionTemplates[type](name);
  }
}

nameInput.addEventListener("input", autoGenerateDescription);
channelTypeSelect.addEventListener("change", autoGenerateDescription);

// Fetch & render channels
const channelsRef = ref(db,"channels");
onValue(channelsRef, snapshot=>{
  channelsData = snapshot.val() || {};
  renderChannels();
});

function renderChannels(){
  channelList.innerHTML="";
  const searchTerm = searchInput.value.toLowerCase();
  const selectedCategory = filterCategory.value;

  let filtered = Object.entries(channelsData).filter(([id,ch])=>{
    const matchesCategory = selectedCategory==="All" || ch.category===selectedCategory;
    const matchesSearch = ch.name.toLowerCase().includes(searchTerm);
    return matchesCategory && matchesSearch;
  });

  if(!filtered.length){
    channelList.innerHTML="<p class='text-gray-500'>No matching channels found.</p>";
    return;
  }

  filtered.forEach(([id,ch])=>{
    const card = document.createElement("div");
    card.className="bg-white p-4 rounded-lg shadow flex justify-between items-center";
    card.innerHTML=`
      <div class="flex items-center gap-3">
        <img src="${ch.icon}" class="w-12 h-12 object-contain rounded-lg border border-gray-300"/>
        <div>
          <h2 class="font-semibold text-gray-800">${ch.name}</h2>
          <p class="text-gray-500 text-sm">${ch.category} | ${ch.channelType}</p>
        </div>
      </div>
      <div class="flex gap-2">
        <button class="editBtn bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded"><i class="fas fa-edit"></i></button>
        <button class="deleteBtn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded"><i class="fas fa-trash"></i></button>
      </div>
    `;
    channelList.appendChild(card);
    attachCardEvents(card,id);
  });
}

// Add/Edit channels
channelForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const channelId = document.getElementById("channelId").value;
  const name = nameInput.value.trim();
  const icon = iconHidden.value;
  const stream = document.getElementById("stream").value.trim();
  const category = document.getElementById("category").value;
  const channelType = channelTypeSelect.value;
  const language = document.getElementById("language").value;
  const country = document.getElementById("country").value.trim();
  const tags = document.getElementById("tags").value.trim();
  const description = descriptionBox.value.trim();

  if(!name || !icon || !stream || !category || !channelType || !language || !country){
    showToast("Please fill all required fields","error");
    return;
  }

  try{
    const now = new Date().toISOString();
    const channelData = {name,icon,stream,category,channelType,language,country,tags,description,createdAt: now};

    if(channelId){
      await update(ref(db,"channels/"+channelId),channelData);
      showToast("Channel updated!");
    } else {
      const newRef = push(ref(db,"channels"));
      await set(newRef,channelData);
      showToast("Channel added!");
    }
    channelForm.reset();
    modal.classList.add("hidden");
  } catch(err){
    showToast("Error: "+err.message,"error");
  }
});

// Attach edit/delete
function attachCardEvents(card,id){
  const editBtn = card.querySelector(".editBtn");
  const deleteBtn = card.querySelector(".deleteBtn");

  editBtn.addEventListener("click",()=>{
    modal.classList.remove("hidden");
    const ch = channelsData[id];
    document.getElementById("channelId").value=id;
    nameInput.value=ch.name;
    iconHidden.value=ch.icon;
    document.getElementById("stream").value=ch.stream;
    document.getElementById("category").value=ch.category;
    channelTypeSelect.value=ch.channelType;
    document.getElementById("language").value=ch.language;
    document.getElementById("country").value=ch.country;
    document.getElementById("tags").value=ch.tags;
    descriptionBox.value=ch.description;
  });

  deleteBtn.addEventListener("click",async()=>{
    if(confirm("Are you sure you want to delete this channel?")){
      await remove(ref(db,"channels/"+id));
      showToast("Channel deleted!");
    }
  });
}

// Search & filter
searchInput.addEventListener("input",renderChannels);
filterCategory.addEventListener("change",renderChannels);
</script>

</body>
</html>
