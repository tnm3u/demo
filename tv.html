<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live TV</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Icons & Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet">

<!-- Players -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.compiled.js"></script>

<style>
body{background:#121212;color:#fff;font-family:Roboto}
.channel-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:.75rem}
.channel-card{background:#1E1E1E;border-radius:.75rem;padding:.5rem;text-align:center;cursor:pointer;transition:.2s}
.channel-card:hover{transform:scale(1.05)}
.channel-card img{width:100%;height:70px;object-fit:contain;border-radius:.5rem}
</style>
</head>
<body>

<!-- HEADER -->
<div class="p-4 bg-black text-lg font-bold">Live TV</div>

<!-- ADD PLAYLIST -->
<div class="p-4 bg-[#1E1E1E]">
  <div class="flex gap-2">
    <input id="plName" placeholder="Playlist name"
      class="flex-1 px-3 py-2 rounded bg-black border border-gray-700">
    <input id="plUrl" placeholder="M3U playlist URL"
      class="flex-[2] px-3 py-2 rounded bg-black border border-gray-700">
    <button onclick="addPlaylist()" class="px-4 py-2 bg-green-600 rounded">Add</button>
  </div>
</div>

<!-- PLAYLIST LIST -->
<div id="playlistList" class="p-4 space-y-2"></div>

<!-- CHANNEL VIEW -->
<div id="channelView" class="hidden p-4">
  <div class="flex justify-between items-center mb-4">
    <button onclick="backToPlaylists()" class="px-4 py-2 bg-gray-800 rounded">‚Üê Back</button>
    <div class="flex gap-2">
      <button class="sort-btn bg-gray-800 p-2 rounded" data-sort="az">
        <span class="material-symbols-outlined">sort_by_alpha</span>
      </button>
      <button class="sort-btn bg-gray-800 p-2 rounded" data-sort="za">
        <span class="material-symbols-outlined rotate-180">sort_by_alpha</span>
      </button>
      <button onclick="toggleView()" class="bg-gray-800 p-2 rounded">
        <span id="viewIcon" class="material-symbols-outlined">grid_view</span>
      </button>
    </div>
  </div>

  <h2 id="playlistTitle" class="font-semibold mb-3"></h2>
  <div id="channelGrid" class="channel-grid"></div>
</div>

<!-- PLAYER -->
<div id="playerModal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center">
  <div class="relative w-[90%] max-w-[720px]">
    <span onclick="closePlayer()" class="absolute top-2 right-2 text-3xl cursor-pointer">&times;</span>
    <video id="playerVideo" controls class="w-full h-[420px] bg-black"></video>
  </div>
</div>

<script>
/* ================= PLAYLIST STORAGE ================= */

const STORAGE_KEY = "saved_playlists";
let playlists = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

let currentChannels = [];
let currentView = "grid";
let currentSort = "az";

/* ================= SAVE / LOAD ================= */

function savePlaylists(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(playlists));
  renderPlaylists();
}

/* ================= ADD / EDIT / DELETE ================= */

function addPlaylist(){
  if(!plName.value || !plUrl.value) return alert("Enter name & URL");
  playlists.push({ id: Date.now(), name: plName.value.trim(), url: plUrl.value.trim() });
  plName.value=""; plUrl.value="";
  savePlaylists();
}

function deletePlaylist(id){
  if(confirm("Delete playlist?")){
    playlists = playlists.filter(p=>p.id!==id);
    savePlaylists();
  }
}

function editPlaylist(id){
  const p = playlists.find(x=>x.id===id);
  const name = prompt("Playlist name", p.name);
  const url  = prompt("Playlist URL", p.url);
  if(name && url){ p.name=name; p.url=url; savePlaylists(); }
}

/* ================= RENDER PLAYLISTS ================= */

function renderPlaylists(){
  playlistList.innerHTML="";
  playlists.forEach(p=>{
    const row=document.createElement("div");
    row.className="flex justify-between items-center bg-[#1E1E1E] p-3 rounded";
    row.innerHTML=`
      <div class="cursor-pointer" onclick="openPlaylist(${p.id})">üì∫ ${p.name}</div>
      <div class="flex gap-2">
        <button onclick="editPlaylist(${p.id})" class="bg-blue-600 px-2 rounded">Edit</button>
        <button onclick="deletePlaylist(${p.id})" class="bg-red-600 px-2 rounded">Delete</button>
      </div>`;
    playlistList.appendChild(row);
  });
}

/* ================= ROBUST M3U PARSER ================= */

function parseM3U(text){
  text = text.replace(/^\uFEFF/, "");
  const lines = text.split(/\r?\n/);
  const out=[];
  let temp=null;

  for(let l of lines){
    l=l.trim();
    if(!l) continue;

    if(l.startsWith("#EXTINF")){
      temp={
        name: l.split(",").slice(1).join(",").trim(),
        logo: (l.match(/tvg-logo="([^"]+)"/i)||[])[1]||""
      };
    }else if(!l.startsWith("#") && temp){
      temp.stream=l;
      out.push(temp);
      temp=null;
    }
  }
  return out;
}

/* ================= OPEN PLAYLIST ================= */

async function openPlaylist(id){
  const p = playlists.find(x=>x.id===id);
  playlistTitle.textContent = p.name;

  try{
    const res = await fetch("fetch.php?url=" + encodeURIComponent(p.url));
    const txt = await res.text();
    currentChannels = parseM3U(txt);
  }catch(e){
    alert("Unable to load playlist");
    return;
  }

  playlistList.style.display="none";
  channelView.classList.remove("hidden");
  renderChannels();
}

function backToPlaylists(){
  channelView.classList.add("hidden");
  playlistList.style.display="block";
}

/* ================= CHANNEL UI ================= */

function renderChannels(){
  let list=[...currentChannels];
  if(currentSort==="az") list.sort((a,b)=>a.name.localeCompare(b.name));
  if(currentSort==="za") list.sort((a,b)=>b.name.localeCompare(a.name));

  channelGrid.className=currentView==="grid"
    ? "channel-grid"
    : "flex flex-col gap-2";

  channelGrid.innerHTML="";
  list.forEach(ch=>{
    const div=document.createElement("div");
    div.className=currentView==="grid"
      ? "channel-card"
      : "flex items-center gap-3 bg-[#1E1E1E] p-3 rounded cursor-pointer";

    div.innerHTML=currentView==="grid"
      ? `<img src="${ch.logo}"><div class="mt-1">${ch.name}</div>`
      : `<img src="${ch.logo}" class="w-12 h-12"><div>${ch.name}</div>`;

    div.onclick=()=>openPlayer(ch.stream);
    channelGrid.appendChild(div);
  });
}

/* ================= SORT / VIEW ================= */

document.querySelectorAll('.sort-btn').forEach(b=>{
  b.onclick=()=>{currentSort=b.dataset.sort; renderChannels();}
});

function toggleView(){
  currentView=currentView==="grid"?"list":"grid";
  viewIcon.textContent=currentView==="grid"?"grid_view":"list";
  renderChannels();
}

/* ================= PLAYER ================= */

let shakaPlayer=null;
function openPlayer(url){
  if(playerVideo.hls){playerVideo.hls.destroy();playerVideo.hls=null;}
  if(shakaPlayer){shakaPlayer.destroy();shakaPlayer=null;}

  if(url.includes(".m3u8")){
    if(Hls.isSupported()){
      const hls=new Hls();
      hls.loadSource(url);
      hls.attachMedia(playerVideo);
      playerVideo.hls=hls;
    }else playerVideo.src=url;
  }else if(url.includes(".mpd")){
    shaka.polyfill.installAll();
    shakaPlayer=new shaka.Player(playerVideo);
    shakaPlayer.load(url).catch(()=>alert("Cannot play stream"));
  }else playerVideo.src=url;

  playerModal.classList.remove("hidden");
  playerVideo.play();
}

function closePlayer(){
  if(playerVideo.hls) playerVideo.hls.destroy();
  if(shakaPlayer) shakaPlayer.destroy();
  playerVideo.pause();
  playerModal.classList.add("hidden");
}

/* ================= INIT ================= */
renderPlaylists();
</script>

</body>
</html>